<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BikeGuard - Dashboard</title>
        <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
                 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
         <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
         <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
        <style>
            .gradient-bg {
                background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
            }
            .gradient-dark {
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            }
            .animate-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-ping {
                animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
            }
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            @keyframes ping {
                75%,
                100% {
                    transform: scale(2);
                    opacity: 0;
                }
            }
            .tab-active {
                background-color: #059669;
                color: white;
            }
            .tab-inactive {
                color: #9ca3af;
            }
            .tab-inactive:hover {
                color: white;
            }
                         .slide-in {
                 animation: slideIn 0.5s ease-out;
             }
             @keyframes slideIn {
                 from {
                     opacity: 0;
                     transform: translateY(20px);
                 }
                 to {
                     opacity: 1;
                     transform: translateY(0);
                 }
             }
             
             /* Chatbox specific styles */
             #support-chatbox {
                 transition: all 0.3s ease;
             }
             
             #support-chatbox:not(:visible) {
                 pointer-events: none;
             }
             
             #support-chatbox:visible {
                 pointer-events: auto;
             }
        </style>
    </head>
    <body class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-emerald-100 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex items-center">
                        <a href="index.html" class="flex items-center">
                            <i data-lucide="shield" class="h-8 w-8 text-emerald-600"></i>
                            <span class="ml-2 text-xl font-bold text-gray-900">BikeGuard</span>
                        </a>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></div>
                            <span class="text-emerald-600 text-sm font-medium">Online</span>
                        </div>

                        <div class="relative">
                            <button
                                id="user-menu-btn"
                                class="flex items-center space-x-2 text-gray-700 hover:text-emerald-600 transition-colors duration-200">
                                <div
                                    class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="h-5 w-5 text-emerald-600"></i>
                                </div>
                                <span id="user-name" class="font-medium">User</span>
                                <i data-lucide="chevron-down" class="h-4 w-4"></i>
                            </button>

                            <!-- Dropdown Menu -->
                            <div
                                id="user-menu"
                                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden">
                                <div class="py-1">
                                    <button
                                        id="logout-btn"
                                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Welcome Section -->
            <div class="mb-8 slide-in">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    Welcome back, <span id="welcome-name">User</span>!
                </h1>
                <p class="text-gray-600">
                    Theo d√µi v√† b·∫£o v·ªá xe m√°y c·ªßa b·∫°n v·ªõi th√¥ng tin chi ti·∫øt theo th·ªùi gian th·ª±c.
                </p>
            </div>

            <!-- Main Dashboard -->
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Map Section -->
                    <div
                        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden slide-in">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-900">Live Location</h2>
                                <div class="flex items-center space-x-2">
                                    <div
                                        class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <span class="text-emerald-600 text-sm font-medium">Live</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <!-- OpenStreetMap (Leaflet) container -->
                            <div id="map" class="relative h-80 rounded-lg overflow-hidden"></div>
                            <div class="mt-4 flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">C·∫≠p nh·∫≠t cu·ªëi:</span> <span id="last-seen-time">ƒêang ch·ªù...</span>
                                </div>
                                <a
                                    href="https://www.google.com/maps/search/?api=1&query=10.762833,106.682461"
                                    target="_blank"
                                    class="text-emerald-600 hover:text-emerald-700 font-medium text-sm">
                                    Xem b·∫£n ƒë·ªì ƒë·∫ßy ƒë·ªß
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Vibration History Chart -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 slide-in">
                        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-gray-900">
                                L·ªãch s·ª≠ rung l·∫Øc xe m√°y
                            </h2>
                            <span class="text-gray-400 text-sm">Bi·ªÉu ƒë·ªì th·ªùi gian th·ª±c</span>
                        </div>
                        <div class="p-6">
                            <canvas id="vibrationChart" height="80" style="width: 100%; height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 slide-in">
                        <div class="flex items-center justify-between mb-4">
                            <div class="bg-purple-100 rounded-lg p-3">
                                <i data-lucide="map-pin" class="h-6 w-6 text-purple-600"></i>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="distance-value" class="text-purple-600 font-semibold text-lg">--</span>
                                <button id="refresh-location" class="p-1 text-purple-400 hover:text-purple-600 transition-colors" title="L√†m m·ªõi v·ªã tr√≠">
                                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Kho·∫£ng c√°ch</h3>
                        <p class="text-gray-600 text-sm">T·ª´ thi·∫øt b·ªã c·ªßa b·∫°n</p>
                        <div id="location-help" class="mt-2 p-2 bg-blue-50 rounded-lg text-xs text-blue-700 hidden">
                            <i data-lucide="info" class="h-3 w-3 inline mr-1"></i>
                            <strong>H∆∞·ªõng d·∫´n:</strong> Cho ph√©p truy c·∫≠p v·ªã tr√≠ ho·∫∑c s·ª≠ d·ª•ng n√∫t refresh ƒë·ªÉ l·∫•y v·ªã tr√≠ m·∫∑c ƒë·ªãnh
                        </div>
                    </div>
                                     <!-- Quick Actions -->
                 <div class="bg-white rounded-xl shadow-sm border border-gray-200 slide-in">
                     <div class="p-6 border-b border-gray-200">
                         <h2 class="text-xl font-semibold text-gray-900">Quick Actions</h2>
                     </div>

                     <div class="p-6 space-y-4">
                         <!-- Toggle Anti-theft Alert -->
                         <div class="flex items-center justify-between">
                             <div class="flex items-center">
                                 <i
                                     data-lucide="shield"
                                     class="h-5 w-5 text-emerald-600 mr-2"></i>
                                 <span class="font-medium text-gray-800"
                                     >C·∫£nh b√°o ch·ªëng tr·ªôm</span
                                 >
                             </div>
                             <!-- Switch style -->
                             <label class="relative inline-flex items-center cursor-pointer">
                                 <input type="checkbox" id="alert-toggle" class="sr-only peer" />
                                 <div
                                     class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 transition-all duration-200"></div>
                                 <div
                                     class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                             </label>
                         </div>
                         <!-- Toggle Auto Anti-theft Mode -->
                         <div class="flex items-center justify-between">
                             <div class="flex items-center">
                                 <i data-lucide="zap" class="h-5 w-5 text-yellow-500 mr-2"></i>
                                 <span class="font-medium text-gray-800"
                                     >Ch·ªëng tr·ªôm t·ª± ƒë·ªông</span
                                 >
                             </div>
                             <!-- Switch style -->
                             <label class="relative inline-flex items-center cursor-pointer">
                                 <input type="checkbox" id="auto-toggle" class="sr-only peer" />
                                 <div
                                     class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-yellow-400 transition-all duration-200"></div>
                                 <div
                                     class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                             </label>
                         </div>
                         <!-- Toggle Turn off Anti-theft Ring -->
                         <div class="flex items-center justify-between">
                             <div class="flex items-center">
                                 <i
                                     data-lucide="alert-triangle"
                                     class="h-5 w-5 text-red-600 mr-2"></i>
                                 <span class="font-medium text-gray-800">Chu√¥ng ch·ªëng tr·ªôm</span>
                             </div>
                             <!-- Switch style -->
                             <label class="relative inline-flex items-center cursor-pointer">
                                 <input
                                     type="checkbox"
                                     id="alert-ring-toggle"
                                     class="sr-only peer" />
                                 <div
                                     class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-500 transition-all duration-200"></div>
                                 <div
                                     class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                             </label>
                         </div>
                         
                         <!-- Notification Settings -->
                         <div class="pt-4 border-t border-gray-200">
                             <h3 class="text-lg font-semibold text-gray-900 mb-3">C√†i ƒë·∫∑t th√¥ng b√°o</h3>
                             
                             <!-- PushSafer Notifications -->
                             <div class="flex items-center justify-between mb-3">
                                 <div class="flex items-center">
                                     <i data-lucide="smartphone" class="h-5 w-5 text-blue-600 mr-2"></i>
                                     <span class="font-medium text-gray-800">Th√¥ng b√°o ƒëi·ªán tho·∫°i</span>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                     <input type="checkbox" id="pushsafer-toggle" class="sr-only peer" checked />
                                     <div
                                         class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-all duration-200"></div>
                                     <div
                                         class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                                 </label>
                             </div>
                             
                             <!-- Email Notifications -->
                             <div class="flex items-center justify-between mb-3">
                                 <div class="flex items-center">
                                     <i data-lucide="mail" class="h-5 w-5 text-green-600 mr-2"></i>
                                     <span class="font-medium text-gray-800">Th√¥ng b√°o email</span>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                     <input type="checkbox" id="email-toggle" class="sr-only peer" />
                                     <div
                                         class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-green-600 transition-all duration-200"></div>
                                     <div
                                         class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                                 </label>
                             </div>
                         </div>
                     </div>
                 </div>
                </div>
                <!-- Support -->
                <div class="fixed bottom-6 right-6 z-50">
                    <button
                        id="contact-support-btn"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-full shadow-lg transition-all duration-300">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.83L3 20l1.32-3.16A8.95 8.95 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </button>
                </div>
                                 <!-- Chatbox Modal -->
                 <div
                     id="support-chatbox"
                     class="fixed inset-0 z-50 flex items-end justify-end px-4 py-8"
                     style="display: none; pointer-events: none;">
                     <div
                         class="w-full max-w-sm bg-white rounded-xl shadow-2xl border border-emerald-200 slide-in"
                         style="pointer-events: auto;">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="headphones" class="h-5 w-5 text-emerald-600"></i>
                                <span class="font-semibold text-gray-900">Support Chat</span>
                                <div id="sensor-indicator" class="hidden">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                </div>
                            </div>
                            <button
                                id="close-chatbox-btn"
                                class="text-gray-400 hover:text-emerald-600 transition-colors">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <div
                            class="p-4 h-64 overflow-y-auto text-sm text-gray-700 flex flex-col gap-2">
                            <div
                                class="self-start bg-emerald-50 text-emerald-900 px-3 py-2 rounded-lg mb-2">
                                Hi üëã, how can we help you today?
                            </div>
                        </div>
                        <form class="flex items-center border-t border-gray-100 p-2">
                            <input
                                type="text"
                                class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-200 text-sm"
                                placeholder="Type your message..." />
                            <button
                                type="submit"
                                class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                                Send
                            </button>
                        </form>
                        <div class="text-xs text-gray-400 text-center pb-2">
                            Live chat coming soon
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script src="assets/js/jquery-3.7.1.min.js"></script>
        <script type="module" src="assets/js/firebase.js"></script>
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
            import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
            
            const firebaseConfig = {
                apiKey: "YOUR_FIREBASE_API_KEY",
                authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
                databaseURL: "YOUR_FIREBASE_DATABASE_URL",
                projectId: "YOUR_FIREBASE_PROJECT_ID",
                storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
                messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
                appId: "YOUR_FIREBASE_APP_ID"
            };

            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);

            // Global functions for sensor updates
            window.addSensorMessageToChat = function(message, type = 'info') {
                var $chatBody = $("#support-chatbox .p-4.h-64");
                var bgClass = "bg-blue-50 text-blue-900";
                var icon = "üîµ";
                
                // Set different colors based on message type
                switch(type) {
                    case 'alert':
                        bgClass = "bg-red-50 text-red-900";
                        icon = "üö®";
                        break;
                    case 'warning':
                        bgClass = "bg-yellow-50 text-yellow-900";
                        icon = "‚ö†Ô∏è";
                        break;
                    case 'success':
                        bgClass = "bg-green-50 text-green-900";
                        icon = "‚úÖ";
                        break;
                    case 'vibration':
                        bgClass = "bg-purple-50 text-purple-900";
                        icon = "üì≥";
                        break;
                    case 'gps':
                        bgClass = "bg-blue-50 text-blue-900";
                        icon = "üìç";
                        break;
                }
                
                var $sensorDiv = $("<div>")
                    .addClass("self-start " + bgClass + " px-3 py-2 rounded-lg mb-2 max-w-xs");
                
                var messageHtml = icon + " " + message.replace(/\n/g, '<br>');
                $sensorDiv.html(messageHtml);
                $chatBody.append($sensorDiv);
                $chatBody.scrollTop($chatBody[0].scrollHeight);
                
                // Show indicator
                $("#sensor-indicator").removeClass("hidden");
                setTimeout(function() {
                    $("#sensor-indicator").addClass("hidden");
                }, 3000);
            };

            // GPS specific function (for backward compatibility)
            window.addGPSMessageToChat = function(message, lat, lng) {
                var messageHtml = message;
                if (lat && lng) {
                    messageHtml += '\n<a href="https://www.google.com/maps/search/?api=1&query=' + lat + ',' + lng + '" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs underline">üó∫Ô∏è Xem tr√™n Google Maps</a>';
                }
                window.addSensorMessageToChat(messageHtml, 'gps');
            };

                window.updateMapMarker = function(lat, lng) {
                 if (window.bikeMarker) {
                     var timestamp = new Date().toLocaleString('vi-VN');
                     window.updateMapWithGPSData(lat, lng, timestamp);
                 }
             };

             // PushSafer notification function
             window.sendPushSaferNotification = function(lat, lng, time, type = 'theft') {
                 const pushSaferKey = 'YOUR_PUSHSAFER_KEY';
                 
                 let message, title;
                 if (type === 'alarm') {
                     title = 'üö® CHU√îNG CH·ªêNG TR·ªòM ƒê√É K√çCH HO·∫†T! ‚Äì XE B·ªä X√ÇM NH·∫¨P!';
                     message = `üîî Chu√¥ng c·∫£nh b√°o ch·ªëng tr·ªôm ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t! H·ªá th·ªëng ph√°t hi·ªán chuy·ªÉn ƒë·ªông/l·ª±c t√°c ƒë·ªông b·∫•t th∆∞·ªùng v√†o xe.
                üõ°Ô∏è H·ªá th·ªëng ƒëang b·∫£o v·ªá xe c·ªßa b·∫°n.
                üìç V·ªã tr√≠ hi·ªán t·∫°i:
                https://www.google.com/maps/search/?api=1&query=${lat},${lng}
                üïí Th·ªùi gian: ${time}
                ‚ö†Ô∏è H√£y ki·ªÉm tra xe ngay!`;
                 }
                 
                 const encodedMessage = encodeURIComponent(message);
                 const pushSaferUrl = `https://www.pushsafer.com/api?k=${pushSaferKey}&s=8&v=1&t=${encodeURIComponent(title)}&m=${encodedMessage}`;
                 
                 fetch(pushSaferUrl)
                     .then(response => response.json())
                     .then(data => {
                         console.log('PushSafer notification sent:', data);
                         if (data.status === 1) {
                             console.log('‚úÖ PushSafer notification sent successfully');
                         } else {
                             console.error('‚ùå PushSafer notification failed');
                         }
                     })
                     .catch(error => {
                         console.error('Error sending PushSafer notification:', error);
                     });
             };

             // Email notification function (using EmailJS)
             window.sendEmailNotification = function(lat, lng, time, type = 'theft') {
                 // Check if EmailJS is loaded
                 if (typeof emailjs === 'undefined') {
                     console.warn('EmailJS not loaded, skipping email notification');
                     return;
                 }

                 const userEmail = localStorage.getItem('notification_email');
                 if (!userEmail) {
                     console.warn('No email configured for notifications');
                     return;
                 }

                 let subject, message;
                 if (type === 'alarm') {
                     subject = 'CHU√îNG CH·ªêNG TR·ªòM ƒê√É K√çCH HO·∫†T! ‚Äì XE B·ªä X√ÇM NH·∫¨P!';
                     message = `Chu√¥ng c·∫£nh b√°o ch·ªëng tr·ªôm ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t! H·ªá th·ªëng ph√°t hi·ªán chuy·ªÉn ƒë·ªông/l·ª±c t√°c ƒë·ªông b·∫•t th∆∞·ªùng v√†o xe.

üõ°Ô∏è H·ªá th·ªëng ƒëang b·∫£o v·ªá xe c·ªßa b·∫°n.
üìç V·ªã tr√≠ hi·ªán t·∫°i: https://www.google.com/maps/search/?api=1&query=${lat},${lng}
üïí Th·ªùi gian: ${time}

‚ö†Ô∏è H√£y ki·ªÉm tra xe ngay!

---
BikeGuard Security System
https://bikeguard.com`;
                 }

                 const templateParams = {
                     to_email: userEmail,
                     subject: subject,
                     message: message,
                     from_name: 'BikeGuard Security'
                 };

                 emailjs.send('YOUR_EMAILJS_SERVICE_ID', 'YOUR_EMAILJS_TEMPLATE_ID', templateParams)
                     .then(function(response) {
                         console.log('‚úÖ Email notification sent successfully:', response);
                     }, function(error) {
                         console.error('‚ùå Email notification failed:', error);
                     });
             };

                // Listen for GPS position updates
                 onValue(ref(database, "posBike"), (snapshot) => {
                     const posData = snapshot.val();
                     if (posData && posData.lat && posData.lon) {
                         const currentTime = new Date().toLocaleString('vi-VN');
                         const gpsMessage = `V·ªã tr√≠ xe m√°y m·ªõi c·∫≠p nh·∫≠t:\nüåç Kinh ƒë·ªô: ${posData.lon.toFixed(6)}\nüåç Vƒ© ƒë·ªô: ${posData.lat.toFixed(6)}\n‚è∞ Th·ªùi gian: ${currentTime}`;
                         
                         // Trigger GPS update event
                         window.dispatchEvent(new CustomEvent('gpsUpdate', {
                             detail: {
                                 message: gpsMessage,
                                 lat: posData.lat,
                                 lng: posData.lon
                             }
                         }));
                     }
                 });

                    // Listen for alert status changes
                  onValue(ref(database, "alert"), (snapshot) => {
                      const alertStatus = snapshot.val();
                      const currentTime = new Date().toLocaleString('vi-VN');
                      
                      if (alertStatus) {
                          const alertMessage = `C·∫£nh b√°o ch·ªëng tr·ªôm ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!\nüõ°Ô∏è Tr·∫°ng th√°i: B·∫≠t\n‚è∞ Th·ªùi gian: ${currentTime}`;
                          window.dispatchEvent(new CustomEvent('alertUpdate', {
                              detail: { message: alertMessage, status: true, time: currentTime }
                          }));
                      } else {
                          const alertMessage = `C·∫£nh b√°o ch·ªëng tr·ªôm ƒë√£ ƒë∆∞·ª£c t·∫Øt.\nüõ°Ô∏è Tr·∫°ng th√°i: T·∫Øt\n‚è∞ Th·ªùi gian: ${currentTime}`;
                          window.dispatchEvent(new CustomEvent('alertUpdate', {
                              detail: { message: alertMessage, status: false, time: currentTime }
                          }));
                      }
                  });

                 // Listen for auto mode changes
                 onValue(ref(database, "auto"), (snapshot) => {
                     const autoStatus = snapshot.val();
                     const currentTime = new Date().toLocaleString('vi-VN');
                     
                     if (autoStatus) {
                         const autoMessage = `Ch·∫ø ƒë·ªô ch·ªëng tr·ªôm t·ª± ƒë·ªông ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!\n‚ö° Tr·∫°ng th√°i: B·∫≠t\n‚è∞ Th·ªùi gian: ${currentTime}`;
                         window.dispatchEvent(new CustomEvent('autoUpdate', {
                             detail: { message: autoMessage, status: true }
                         }));
                     } else {
                         const autoMessage = `Ch·∫ø ƒë·ªô ch·ªëng tr·ªôm t·ª± ƒë·ªông ƒë√£ ƒë∆∞·ª£c t·∫Øt.\n‚ö° Tr·∫°ng th√°i: T·∫Øt\n‚è∞ Th·ªùi gian: ${currentTime}`;
                         window.dispatchEvent(new CustomEvent('autoUpdate', {
                             detail: { message: autoMessage, status: false }
                         }));
                     }
                 });

                 // Listen for alert ring changes
                 onValue(ref(database, "alertRing"), (snapshot) => {
                     const ringStatus = snapshot.val();
                     const currentTime = new Date().toLocaleString('vi-VN');
                     
                     if (ringStatus) {
                         const ringMessage = `Chu√¥ng c·∫£nh b√°o ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!\nüîî Tr·∫°ng th√°i: B·∫≠t\n‚è∞ Th·ªùi gian: ${currentTime}`;
                         window.dispatchEvent(new CustomEvent('alertRingUpdate', {
                             detail: { message: ringMessage, status: true }
                         }));
                     } else {
                         const ringMessage = `Chu√¥ng c·∫£nh b√°o ƒë√£ ƒë∆∞·ª£c t·∫Øt.\nüîî Tr·∫°ng th√°i: T·∫Øt\n‚è∞ Th·ªùi gian: ${currentTime}`;
                         window.dispatchEvent(new CustomEvent('alertRingUpdate', {
                             detail: { message: ringMessage, status: false }
                         }));
                     }
                 });

                 // Listen for vibration data updates
                 onValue(ref(database, "vibrationData"), (snapshot) => {
                     const vibrationData = snapshot.val();
                    if(vibrationData){
                        const ringMessage = 'H·ªá th·ªëng ph√°t hi·ªán chuy·ªÉn ƒë·ªông/l·ª±c t√°c ƒë·ªông b·∫•t th∆∞·ªùng v√†o xe. S·ªë l·∫ßn rung l·∫Øc: ' + vibrationData.numberOfVibration;
                        window.dispatchEvent(new CustomEvent('vibrationUpdate', {
                            detail: { message: ringMessage, status: true }
                        }));
                    }
                     // Lu√¥n c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì, k·ªÉ c·∫£ khi kh√¥ng c√≥ d·ªØ li·ªáu
                     if (window.updateVibrationChart) {
                         window.updateVibrationChart(vibrationData);
                     } else {
                         console.error('‚ùå H√†m updateVibrationChart ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a');
                     }
                 });
        </script>
        <script>
            // S·ª≠ d·ª•ng jQuery cho to√†n b·ªô logic
            $(function () {
                // Initialize Lucide icons
                 lucide.createIcons();

                 // Request notification permission
                 if (Notification.permission === "default") {
                     Notification.requestPermission();
                 }
                 
                 // Initialize EmailJS (you need to replace with your actual EmailJS credentials)
                 if (typeof emailjs !== 'undefined') {
                     emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");
                 }

                // Load user data
                var userData = JSON.parse(localStorage.getItem("bikeguard_user") || "{}");

                // Update user name in header and welcome message
                if (userData.firstName) {
                    $("#user-name").text(userData.firstName);
                    $("#welcome-name").text(userData.firstName);
                } else if (userData.email) {
                    var name = userData.email.split("@")[0];
                    $("#user-name").text(name);
                    $("#welcome-name").text(name);
                }
                
                // Save user email for notifications if available
                if (userData.email) {
                    localStorage.setItem('notification_email', userData.email);
                }

                // User menu toggle
                $("#user-menu-btn").on("click", function (e) {
                    $("#user-menu").toggleClass("hidden");
                    e.stopPropagation();
                });

                // Close menu when clicking outside
                $(document).on("click", function (e) {
                    if (
                        !$(e.target).closest("#user-menu-btn").length &&
                        !$(e.target).closest("#user-menu").length
                    ) {
                        $("#user-menu").addClass("hidden");
                    }
                });

                // Logout functionality
                $("#logout-btn").on("click", function () {
                    localStorage.removeItem("bikeguard_user");
                    window.location.href = "auth.html";
                });

                // L·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng ƒë·ªÉ t√≠nh kho·∫£ng c√°ch v·ªõi error handling t·ªët h∆°n
                function getUserLocation() {
                    // Ki·ªÉm tra xem tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ geolocation kh√¥ng
                    if (!navigator.geolocation) {
                        console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation");
                        $("#distance-value").text("Kh√¥ng h·ªó tr·ª£");
                        return;
                    }

                    // T√πy ch·ªçn cho geolocation - b·∫Øt ƒë·∫ßu v·ªõi ƒë·ªô ch√≠nh x√°c th·∫•p ƒë·ªÉ tr√°nh l·ªói Google API
                    var options = {
                        enableHighAccuracy: false,  // B·∫Øt ƒë·∫ßu v·ªõi ƒë·ªô ch√≠nh x√°c th·∫•p
                        timeout: 10000,            // Gi·∫£m timeout xu·ªëng 10 gi√¢y
                        maximumAge: 300000         // Cache v·ªã tr√≠ trong 5 ph√∫t
                    };

                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            window.userLat = position.coords.latitude;
                            window.userLng = position.coords.longitude;
                            console.log("‚úÖ L·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng th√†nh c√¥ng:", window.userLat, window.userLng);
                            
                            // T√≠nh kho·∫£ng c√°ch v·ªõi v·ªã tr√≠ xe m√°y hi·ªán t·∫°i
                            var distance = haversine(window.userLat, window.userLng, bikeLat, bikeLng);

                            // Hi·ªÉn th·ªã kho·∫£ng c√°ch (l√†m tr√≤n, ƒë∆°n v·ªã m√©t ho·∫∑c km)
                            var display = "";
                            if (distance >= 1000) {
                                display = (distance / 1000).toFixed(2) + " km";
                            } else {
                                display = Math.round(distance) + " m";
                            }
                            $("#distance-value").text(display);
                            
                            // ·∫®n th√¥ng b√°o h∆∞·ªõng d·∫´n n·∫øu c√≥
                            $("#location-help").addClass("hidden").removeClass("block");
                        },
                        function (error) {
                            console.log("‚ùå L·ªói l·∫•y v·ªã tr√≠:", error.code, error.message);
                            
                            var errorMessage = "";
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠";
                                    $("#location-help").removeClass("hidden").addClass("block");
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "H·∫øt th·ªùi gian ch·ªù";
                                    break;
                                default:
                                    errorMessage = "L·ªói kh√¥ng x√°c ƒë·ªãnh";
                                    break;
                            }
                            
                            // S·ª≠ d·ª•ng t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh c·ªë ƒë·ªãnh thay v√¨ IP-based geolocation
                            window.userLat = 10.762824;
                            window.userLng = 106.682437;
                            
                            // T√≠nh kho·∫£ng c√°ch v·ªõi v·ªã tr√≠ xe m√°y hi·ªán t·∫°i
                            var distance = haversine(window.userLat, window.userLng, bikeLat, bikeLng);
                            var display = "";
                            if (distance >= 1000) {
                                display = (distance / 1000).toFixed(2) + " km";
                            } else {
                                display = Math.round(distance) + " m";
                            }
                            $("#distance-value").text(display + " (m·∫∑c ƒë·ªãnh)");
                            
                            // ·∫®n th√¥ng b√°o h∆∞·ªõng d·∫´n
                            $("#location-help").addClass("hidden").removeClass("block");
                        },
                        options
                    );
                }

                // G·ªçi h√†m l·∫•y v·ªã tr√≠
                getUserLocation();

                // Event listener cho n√∫t refresh location
                $("#refresh-location").on("click", function() {
                    $("#distance-value").text("ƒêang t√≠nh...");
                    
                    // Th·ª≠ geolocation tr∆∞·ªõc, n·∫øu th·∫•t b·∫°i th√¨ d√πng t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                window.userLat = position.coords.latitude;
                                window.userLng = position.coords.longitude;
                                console.log("‚úÖ L·∫•y v·ªã tr√≠ th√†nh c√¥ng:", window.userLat, window.userLng);
                                
                                var distance = haversine(window.userLat, window.userLng, bikeLat, bikeLng);
                                var display = "";
                                if (distance >= 1000) {
                                    display = (distance / 1000).toFixed(2) + " km";
                                } else {
                                    display = Math.round(distance) + " m";
                                }
                                $("#distance-value").text(display);
                                $("#location-help").addClass("hidden").removeClass("block");
                            },
                            function(error) {
                                
                                // S·ª≠ d·ª•ng t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh c·ªë ƒë·ªãnh
                                window.userLat = 10.762824;
                                window.userLng = 106.682437;
                                
                                var distance = haversine(window.userLat, window.userLng, bikeLat, bikeLng);
                                var display = "";
                                if (distance >= 1000) {
                                    display = (distance / 1000).toFixed(2) + " km";
                                } else {
                                    display = Math.round(distance) + " m";
                                }
                                $("#distance-value").text(display + " (m·∫∑c ƒë·ªãnh)");
                                $("#location-help").addClass("hidden").removeClass("block");
                            },
                            { enableHighAccuracy: false, timeout: 8000, maximumAge: 300000 }
                        );
                    } else {
                        // Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation, s·ª≠ d·ª•ng t·ªça ƒë·ªô m·∫∑c ƒë·ªãnh
                        window.userLat = 10.762824;
                        window.userLng = 106.682437;
                        
                        var distance = haversine(window.userLat, window.userLng, bikeLat, bikeLng);
                        var display = "";
                        if (distance >= 1000) {
                            display = (distance / 1000).toFixed(2) + " km";
                        } else {
                            display = Math.round(distance) + " m";
                        }
                        $("#distance-value").text(display + " (m·∫∑c ƒë·ªãnh)");
                        $("#location-help").addClass("hidden").removeClass("block");
                    }
                });

                function haversine(lat1, lon1, lat2, lon2) {
                    var R = 6371e3; // B√°n k√≠nh Tr√°i ƒê·∫•t (m)
                    var toRad = function (angle) {
                        return (angle * Math.PI) / 180;
                    };
                    var dLat = toRad(lat2 - lat1);
                    var dLon = toRad(lon2 - lon1);
                    var a =
                        Math.sin(dLat / 2) ** 2 +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    return R * c; // kho·∫£ng c√°ch t√≠nh b·∫±ng m√©t
                }

                var ctx = document.getElementById("vibrationChart").getContext("2d");

                // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ƒë∆∞·ªùng v·ªõi d·ªØ li·ªáu th·ª±c t·ª´ Firebase
                var vibrationChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: ['ƒêang t·∫£i d·ªØ li·ªáu...'],
                        datasets: [
                            {
                                label: "S·ªë l·∫ßn rung l·∫Øc",
                                data: [0],
                                borderColor: "#10b981",
                                backgroundColor: "rgba(16,185,129,0.1)",
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointBackgroundColor: "#10b981",
                                pointBorderColor: "#fff",
                                pointHoverRadius: 6,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (ctx) {
                                        return ` ${ctx.parsed.y} l·∫ßn`;
                                    },
                                },
                            },
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                title: { display: false },
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: "#f3f4f6" },
                                title: { display: false },
                                ticks: { stepSize: 1 },
                            },
                        },
                    },
                });
                

                // ƒê·∫£m b·∫£o bi·ªÉu ƒë·ªì ƒë∆∞·ª£c hi·ªÉn th·ªã
                setTimeout(function() {
                    vibrationChart.update('none');
                }, 100);

                // H√†m l∆∞u d·ªØ li·ªáu v√†o localStorage
                window.saveVibrationData = function(vibrationDataObject) {
                    if (!vibrationDataObject || typeof vibrationDataObject !== 'object') {
                        return;
                    }

                    // L·∫•y d·ªØ li·ªáu c≈© t·ª´ localStorage
                    var existingData = JSON.parse(localStorage.getItem('vibrationHistory') || '{}');
                    
                    // Th√™m d·ªØ li·ªáu m·ªõi
                    Object.keys(vibrationDataObject).forEach(function(key) {
                        var item = vibrationDataObject[key];
                        if (item && typeof item === 'object') {
                            // Ch·ªâ l∆∞u n·∫øu key ch∆∞a t·ªìn t·∫°i
                            if (!existingData[key]) {
                                // T·∫°o timestamp v·ªõi ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ tr√°nh tr√πng l·∫∑p
                                var timestamp = Date.now() + Math.random() * 1000;
                                existingData[key] = {
                                    hour: item.hour,
                                    numberOfVibration: item.numberOfVibration || 0,
                                    timestamp: timestamp
                                };
                            }
                        }
                    });

                    // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng d·ªØ li·ªáu l∆∞u tr·ªØ (t·ªëi ƒëa 1000 ƒëi·ªÉm)
                    var keys = Object.keys(existingData);
                    if (keys.length > 1000) {
                        // S·∫Øp x·∫øp theo timestamp v√† gi·ªØ l·∫°i 1000 ƒëi·ªÉm m·ªõi nh·∫•t
                        keys.sort(function(a, b) {
                            return existingData[a].timestamp - existingData[b].timestamp;
                        });
                        
                        var keysToRemove = keys.slice(0, keys.length - 1000);
                        keysToRemove.forEach(function(key) {
                            delete existingData[key];
                        });
                    }

                    // L∆∞u v√†o localStorage
                    localStorage.setItem('vibrationHistory', JSON.stringify(existingData));
                };

                // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu t·ª´ localStorage
                window.updateVibrationChart = function(vibrationDataObject) {
                    // L∆∞u d·ªØ li·ªáu m·ªõi v√†o localStorage
                    window.saveVibrationData(vibrationDataObject);
                    // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
                    var storedData = JSON.parse(localStorage.getItem('vibrationHistory') || '{}');
                    
                    if (Object.keys(storedData).length === 0) {
                        // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ d·ªØ li·ªáu
                        vibrationChart.data.labels = ['Ch∆∞a c√≥ d·ªØ li·ªáu rung l·∫Øc'];
                        vibrationChart.data.datasets[0].data = [0];
                        vibrationChart.update('none');
                        
                        var chartTitle = document.querySelector('.bg-white.rounded-xl.shadow-sm.border.border-gray-200.slide-in h2');
                        if (chartTitle) {
                            chartTitle.innerHTML = `L·ªãch s·ª≠ rung l·∫Øc xe m√°y <span class="text-sm font-normal text-gray-500">(ƒêang ch·ªù d·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn)</span>`;
                        }
                        return;
                    }

                    // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh array v√† s·∫Øp x·∫øp theo timestamp
                    var vibrationArray = [];
                    Object.keys(storedData).forEach(function(key) {
                        var item = storedData[key];
                        if (item && typeof item === 'object') {
                            vibrationArray.push({
                                key: key,
                                hour: item.hour,
                                numberOfVibration: item.numberOfVibration || 0,
                                timestamp: item.timestamp
                            });
                        }
                    });

                    // S·∫Øp x·∫øp theo gi·ªù
                    var sortedData = vibrationArray.sort(function(a, b) {
                        return a.hour - b.hour;
                    });

                    // L·∫•y 20 ƒëi·ªÉm d·ªØ li·ªáu g·∫ßn nh·∫•t
                    var recentData = sortedData.slice(-20);

                    // T·∫°o labels v√† data tr·ª±c ti·∫øp t·ª´ d·ªØ li·ªáu
                    var labels = [];
                    var data = [];

                    recentData.forEach(function(item) {
                        // S·ª≠ d·ª•ng hour tr·ª±c ti·∫øp t·ª´ d·ªØ li·ªáu
                        var timeStr = item.hour;
                        
                        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p timeStr r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá
                        if (!timeStr || timeStr === "" || timeStr === "0" || timeStr === 0) {
                            // S·ª≠ d·ª•ng timestamp ƒë·ªÉ t·∫°o th·ªùi gian hi·ªÉn th·ªã
                            var itemTime = new Date(item.timestamp);
                            var displayTime = itemTime.getHours().toString().padStart(2, '0') + ':' + 
                                             itemTime.getMinutes().toString().padStart(2, '0');
                            labels.push(displayTime);
                        } else {
                            labels.push(timeStr);
                        }
                        
                        // S·ª≠ d·ª•ng numberOfVibration tr·ª±c ti·∫øp t·ª´ Firebase
                        data.push(item.numberOfVibration);
                    });

                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                    vibrationChart.data.labels = labels;
                    vibrationChart.data.datasets[0].data = data;
                    vibrationChart.update('none');
                };

                // Initialize Leaflet map with better configuration
                var bikeLat = 10.762824,
                    bikeLng = 106.682437;
                
                // Create map with better options
                var map = L.map("map", {
                    center: [bikeLat, bikeLng],
                    zoom: 16,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    touchZoom: true
                });
                
                // Add tile layer with better styling
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 19,
                    attribution: "&copy; OpenStreetMap contributors",
                    subdomains: 'abc'
                }).addTo(map);
                
                // Create custom bike icon
                var bikeIcon = L.divIcon({
                    html: '<div style="background-color: #10b981; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                    className: 'custom-bike-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // Create bike marker with custom icon
                window.bikeMarker = L.marker([bikeLat, bikeLng], { icon: bikeIcon })
                    .addTo(map)
                    .bindPopup("<b>V·ªã tr√≠ xe m√°y</b><br>ƒêang c·∫≠p nh·∫≠t...")
                    .openPopup();
                
                // Add scale control
                L.control.scale({ imperial: false, metric: true }).addTo(map);
                
                // Function to update map with new GPS data
                window.updateMapWithGPSData = function(lat, lng, timestamp) {
                    if (window.bikeMarker) {
                        // Update marker position
                        window.bikeMarker.setLatLng([lat, lng]);
                        
                        // Update popup content with detailed information
                        var popupContent = `
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 8px 0; color: #10b981; font-weight: bold;">üìç V·ªã tr√≠ xe m√°y</h3>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Kinh ƒë·ªô:</strong> ${lng.toFixed(6)}</p>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Vƒ© ƒë·ªô:</strong> ${lat.toFixed(6)}</p>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>C·∫≠p nh·∫≠t:</strong> ${timestamp}</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" 
                                   target="_blank" 
                                   style="color: #10b981; text-decoration: none; font-size: 11px;">
                                   üó∫Ô∏è Xem tr√™n Google Maps
                                </a>
                            </div>
                        `;
                        
                        window.bikeMarker.bindPopup(popupContent).openPopup();
                        
                        // Smoothly pan to new location
                        map.panTo([lat, lng], { animate: true, duration: 1 });
                        
                        // Update "Last seen" text
                         $("#last-seen-time").text("V·ª´a c·∫≠p nh·∫≠t");
                         
                         // Update Google Maps link
                         var googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                         $('a[href*="google.com/maps"]').attr('href', googleMapsLink);
                         
                         // Update distance calculation if user location is available
                         if (window.userLat && window.userLng) {
                             var distance = haversine(window.userLat, window.userLng, lat, lng);
                             var display = "";
                             if (distance >= 1000) {
                                 display = (distance / 1000).toFixed(2) + " km";
                             } else {
                                 display = Math.round(distance) + " m";
                             }
                             $("#distance-value").text(display);
                         }
                         
                         // Add animation effect to marker
                         window.bikeMarker.getElement().style.animation = 'pulse 1s ease-in-out';
                         setTimeout(function() {
                             window.bikeMarker.getElement().style.animation = '';
                         }, 1000);
                    }
                };

                    // Restore toggle states from localStorage
                 $("#alert-toggle").prop("checked", localStorage.getItem("alert_toggle") === "on");
                 $("#auto-toggle").prop("checked", localStorage.getItem("auto_toggle") === "on");
                 $("#alert-ring-toggle").prop(
                     "checked",
                     localStorage.getItem("alert_ring_toggle") === "on"
                 );
                 
                 // Restore notification toggle states
                 $("#pushsafer-toggle").prop("checked", localStorage.getItem("pushsafer_enabled") !== "false");
                 $("#email-toggle").prop("checked", localStorage.getItem("email_enabled") === "true");
                 
                // Save toggle state on change
                 $("#alert-toggle").on("change", function () {
                     localStorage.setItem("alert_toggle", this.checked ? "on" : "off");
                 });
                 $("#auto-toggle").on("change", function () {
                     localStorage.setItem("auto_toggle", this.checked ? "on" : "off");
                 });
                 $("#alert-ring-toggle").on("change", function () {
                     localStorage.setItem("alert_ring_toggle", this.checked ? "on" : "off");
                 });
                 
                 // Save notification toggle states
                 $("#pushsafer-toggle").on("change", function () {
                     localStorage.setItem("pushsafer_enabled", this.checked);
                 });
                 $("#email-toggle").on("change", function () {
                     localStorage.setItem("email_enabled", this.checked);
                 });
                 
                lucide.createIcons();

                    // Show chatbox
                 $("#contact-support-btn").on("click", function () {
                     $("#support-chatbox").show();
                     lucide.createIcons();
                 });
                 
                 // Hide chatbox
                 $("#close-chatbox-btn").on("click", function () {
                     $("#support-chatbox").hide();
                 });

                // GPS update event listener
                 window.addEventListener('gpsUpdate', function(event) {
                     const { message, lat, lng } = event.detail;
                     
                     // Auto-open chatbox if it's closed
                     if ($("#support-chatbox").is(":hidden")) {
                         $("#support-chatbox").show();
                         lucide.createIcons();
                     }
                     
                     // Add GPS update message to chatbox
                     window.addGPSMessageToChat(message, lat, lng);
                     
                     // Update map marker
                     window.updateMapMarker(lat, lng);
                 });

                // Alert update event listener
                 window.addEventListener('alertUpdate', function(event) {
                     const { message, status, time } = event.detail;
                     
                     // Auto-open chatbox if it's closed
                     if ($("#support-chatbox").is(":hidden")) {
                         $("#support-chatbox").show();
                         lucide.createIcons();
                     }
                     
                     // Add alert message to chatbox
                     window.addSensorMessageToChat(message, status ? 'alert' : 'success');
                     
                     // Show browser notification for critical alerts
                     if (status && Notification.permission === "granted") {
                         new Notification("üö® C·∫£nh b√°o BikeGuard", {
                             body: "C·∫£nh b√°o ch·ªëng tr·ªôm ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!",
                             icon: "/favicon.ico"
                         });
                     }
                     
                    // Send external notifications for critical alerts
                     if (status) {
                         // Get current GPS position for notifications
                         if (window.bikeMarker) {
                             const position = window.bikeMarker.getLatLng();
                             const lat = position.lat;
                             const lng = position.lng;
                             
                             // Send PushSafer notification if enabled
                             if ($("#pushsafer-toggle").is(":checked")) {
                                 console.log('üö® Sending PushSafer notification for anti-theft alert');
                                 window.sendPushSaferNotification(lat, lng, time);
                             }
                             
                             // Send email notification if enabled
                             if ($("#email-toggle").is(":checked")) {
                                 console.log('üìß Sending email notification for anti-theft alert');
                                 window.sendEmailNotification(lat, lng, time);
                             }
                         }
                     }
                 });

                // Auto mode update event listener
                 window.addEventListener('autoUpdate', function(event) {
                     const { message, status } = event.detail;
                     
                     // Auto-open chatbox if it's closed
                     if ($("#support-chatbox").is(":hidden")) {
                         $("#support-chatbox").show();
                         lucide.createIcons();
                     }
                     
                     // Add auto mode message to chatbox
                     window.addSensorMessageToChat(message, status ? 'warning' : 'success');
                 });

                // Alert ring update event listener
                 window.addEventListener('alertRingUpdate', function(event) {
                     const { message, status } = event.detail;
                     
                     // Auto-open chatbox if it's closed
                     if ($("#support-chatbox").is(":hidden")) {
                         $("#support-chatbox").show();
                         lucide.createIcons();
                     }
                     
                     // Add alert ring message to chatbox
                     window.addSensorMessageToChat(message, status ? 'alert' : 'success');
                     
                     // Send notifications when alarm ring is activated
                     if (status) {
                         // Get current GPS position for notifications
                         if (window.bikeMarker) {
                             const position = window.bikeMarker.getLatLng();
                             const lat = position.lat;
                             const lng = position.lng;
                             const currentTime = new Date().toLocaleString('vi-VN');
                             
                             // Send PushSafer notification if enabled
                             if ($("#pushsafer-toggle").is(":checked")) {
                                 console.log('üö® Sending PushSafer notification for alarm ring activation');
                                 window.sendPushSaferNotification(lat, lng, currentTime, 'alarm');
                             }
                             
                             // Send email notification if enabled
                             if ($("#email-toggle").is(":checked")) {
                                 console.log('üìß Sending email notification for alarm ring activation');
                                 window.sendEmailNotification(lat, lng, currentTime, 'alarm');
                             }
                             
                             // Show browser notification
                             if (Notification.permission === "granted") {
                                 new Notification("üö® Chu√¥ng ch·ªëng tr·ªôm ƒë√£ k√≠ch ho·∫°t!", {
                                     body: `Chu√¥ng c·∫£nh b√°o ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t t·∫°i v·ªã tr√≠: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                                     icon: "/favicon.ico",
                                     tag: "alarm-ring"
                                 });
                             }
                         }
                     }
                 });

                // Vibration update event listener
                 window.addEventListener('vibrationUpdate', function(event) {
                     const { message, data } = event.detail;
                     
                     // Auto-open chatbox if it's closed
                     if ($("#support-chatbox").is(":hidden")) {
                         $("#support-chatbox").show();
                         lucide.createIcons();
                     }
                     
                     // Add vibration message to chatbox
                     window.addSensorMessageToChat(message, 'vibration');
                 });

                // Smart bot reply on chat submit
                var $chatForm = $("#support-chatbox form");
                var $chatInput = $chatForm.find('input[type="text"]');
                var $chatBody = $chatForm.parent().find(".p-4.h-64");

                $chatForm.on("submit", function (e) {
                    e.preventDefault();
                    var userMsg = $chatInput.val().trim();
                    if (!userMsg) return;
                    
                    // Append user message
                    var $userDiv = $("<div>")
                        .addClass(
                            "self-end bg-emerald-100 text-emerald-900 px-3 py-2 rounded-lg mb-2"
                        )
                        .text(userMsg);
                    $chatBody.append($userDiv);

                    // Smart bot reply based on user input
                    setTimeout(function () {
                        var botReply = "";
                        
                        // Check if user is asking for coordinates
                        if (userMsg.toLowerCase().includes("t·ªça ƒë·ªô") || userMsg.toLowerCase().includes("toa do")) {
                            if (window.bikeMarker) {
                                var position = window.bikeMarker.getLatLng();
                                var lat = position.lat;
                                var lng = position.lng;
                                var currentTime = new Date().toLocaleString('vi-VN');
                                
                                botReply = `üìç T·ªça ƒë·ªô xe m√°y hi·ªán t·∫°i:\nüåç Kinh ƒë·ªô: ${lng.toFixed(6)}\nüåç Vƒ© ƒë·ªô: ${lat.toFixed(6)}\n‚è∞ C·∫≠p nh·∫≠t: ${currentTime}\n\nüó∫Ô∏è <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Xem tr√™n Google Maps</a>`;
                            } else {
                                botReply = "‚ùå Kh√¥ng th·ªÉ l·∫•y t·ªça ƒë·ªô xe m√°y. Vui l√≤ng th·ª≠ l·∫°i sau.";
                            }
                        } else {
                            // Default reply for other messages
                            botReply = "C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá! Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t.";
                        }
                        
                        var $botDiv = $("<div>")
                            .addClass(
                                "self-start bg-emerald-50 text-emerald-900 px-3 py-2 rounded-lg mb-2"
                            );
                        
                        // If reply contains HTML (like links), use html() method
                        if (botReply.includes('<a href=')) {
                            $botDiv.html(botReply);
                        } else {
                            $botDiv.text(botReply);
                        }
                        
                        $chatBody.append($botDiv);
                        $chatBody.scrollTop($chatBody[0].scrollHeight);
                    }, 600);

                    $chatInput.val("");
                    $chatBody.scrollTop($chatBody[0].scrollHeight);
                });
            });
        </script>
    </body>
</html>

