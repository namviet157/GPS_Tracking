<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikeGuard - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
        }
        .gradient-dark {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .animate-ping {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        .tab-active {
            background-color: #059669;
            color: white;
        }
        .tab-inactive {
            color: #9ca3af;
        }
        .tab-inactive:hover {
            color: white;
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-emerald-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <i data-lucide="shield" class="h-8 w-8 text-emerald-600"></i>
                        <span class="ml-2 text-xl font-bold text-gray-900">BikeGuard</span>
                    </a>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></div>
                        <span class="text-emerald-600 text-sm font-medium">Online</span>
                    </div>
                    
                    <div class="relative">
                        <button id="user-menu-btn" class="flex items-center space-x-2 text-gray-700 hover:text-emerald-600 transition-colors duration-200">
                            <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="h-5 w-5 text-emerald-600"></i>
                            </div>
                            <span id="user-name" class="font-medium">User</span>
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden">
                            <div class="py-1">
                                <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Sign Out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="mb-8 slide-in">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back, <span id="welcome-name">User</span>!</h1>
            <p class="text-gray-600">Theo dõi và bảo vệ xe máy của bạn với thông tin chi tiết theo thời gian thực.</p>
        </div>

        <!-- Main Dashboard -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Map Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden slide-in">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-gray-900">Live Location</h2>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                <span class="text-emerald-600 text-sm font-medium">Live</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- OpenStreetMap (Leaflet) container -->
                        <div id="map" class="relative h-80 rounded-lg overflow-hidden"></div>
                        <div class="mt-4 flex items-center justify-between">
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">Last seen:</span> 2 minutes ago
                            </div>
                            <a 
                                href="https://www.google.com/maps/search/?api=1&query=21.028511,105.804817" 
                                target="_blank" 
                                class="text-emerald-600 hover:text-emerald-700 font-medium text-sm"
                            >
                                View Full Map
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Vibration History Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 slide-in">
                    <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-900">Lịch sử rung lắc xe máy</h2>
                        <span class="text-gray-400 text-sm">Biểu đồ thời gian thực</span>
                    </div>
                    <div class="p-6">
                        <canvas id="vibrationChart" height="80"></canvas>
                    </div>
                </div>
                
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 slide-in">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-purple-100 rounded-lg p-3">
                            <i data-lucide="map-pin" class="h-6 w-6 text-purple-600"></i>
                        </div>
                        <span id="distance-value" class="text-purple-600 font-semibold text-lg">--</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Khoảng cách</h3>
                    <p class="text-gray-600 text-sm">Từ thiết bị của bạn</p>
                </div>
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 slide-in">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">Quick Actions</h2>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <!-- Toggle Anti-theft Alert -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="shield" class="h-5 w-5 text-emerald-600 mr-2"></i>
                                <span class="font-medium text-gray-800">Cảnh báo chống trộm</span>
                            </div>
                            <!-- Switch style -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="alert-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 transition-all duration-200"></div>
                                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                            </label>
                        </div>
                        <!-- Toggle Auto Anti-theft Mode -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="zap" class="h-5 w-5 text-yellow-500 mr-2"></i>
                                <span class="font-medium text-gray-800">Chống trộm tự động</span>
                            </div>
                            <!-- Switch style -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-yellow-400 transition-all duration-200"></div>
                                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                            </label>
                        </div>
                        <!-- Toggle Turn off Anti-theft Ring -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="h-5 w-5 text-red-600 mr-2"></i>
                                <span class="font-medium text-gray-800">Chuông chống trộm</span>
                            </div>
                            <!-- Switch style -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="alert-ring-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-500 transition-all duration-200"></div>
                                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white border border-gray-300 rounded-full shadow transform peer-checked:translate-x-5 transition-all duration-200"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Support -->
            <div class="fixed bottom-6 right-6 z-50">
                <button id="contact-support-btn"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-full shadow-lg transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                            d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.83L3 20l1.32-3.16A8.95 8.95 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </button>
            </div>
            <!-- Chatbox Modal -->
            <div id="support-chatbox" class="fixed inset-0 z-50 flex items-end justify-end px-4 py-8 pointer-events-none">
                <div class="w-full max-w-sm bg-white rounded-xl shadow-2xl border border-emerald-200 slide-in pointer-events-auto" style="display:none;">
                    <div class="flex items-center justify-between p-4 border-b border-gray-100">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="headphones" class="h-5 w-5 text-emerald-600"></i>
                            <span class="font-semibold text-gray-900">Support Chat</span>
                        </div>
                        <button id="close-chatbox-btn" class="text-gray-400 hover:text-emerald-600 transition-colors">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="p-4 h-64 overflow-y-auto text-sm text-gray-700 flex flex-col gap-2">
                        <div class="self-start bg-emerald-50 text-emerald-900 px-3 py-2 rounded-lg mb-2">
                            Hi 👋, how can we help you today?
                        </div>
                    </div>
                    <form class="flex items-center border-t border-gray-100 p-2">
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-200 text-sm" placeholder="Type your message...">
                        <button type="submit" class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            Send
                        </button>
                    </form>
                    <div class="text-xs text-gray-400 text-center pb-2">Live chat coming soon</div>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script>
        // Sử dụng jQuery cho toàn bộ logic
        $(function() {
            // Initialize Lucide icons
            lucide.createIcons();

            // Load user data
            var userData = JSON.parse(localStorage.getItem('bikeguard_user') || '{}');
            
            // Update user name in header and welcome message
            if (userData.firstName) {
                $('#user-name').text(userData.firstName);
                $('#welcome-name').text(userData.firstName);
            } else if (userData.email) {
                var name = userData.email.split('@')[0];
                $('#user-name').text(name);
                $('#welcome-name').text(name);
            }

            // User menu toggle
            $('#user-menu-btn').on('click', function(e) {
                $('#user-menu').toggleClass('hidden');
                e.stopPropagation();
            });

            // Close menu when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#user-menu-btn').length && !$(e.target).closest('#user-menu').length) {
                    $('#user-menu').addClass('hidden');
                }
            });

            // Logout functionality
            $('#logout-btn').on('click', function() {
                localStorage.removeItem('bikeguard_user');
                window.location.href = 'auth.html';
            });

            // Check if user is logged in
            if (!userData.email && !userData.firstName) {
                window.location.href = 'auth.html';
            }

            // Giả lập vị trí xe máy 
            var lat_bike = 13.856219;
            var lon_bike = 109.038577;

            navigator.geolocation.getCurrentPosition(function(position) {
                var lat_user = position.coords.latitude;
                var lon_user = position.coords.longitude;

                // Tính khoảng cách
                var distance = haversine(lat_user, lon_user, lat_bike, lon_bike);

                // Hiển thị khoảng cách (làm tròn, đơn vị mét hoặc km)
                var display = '';
                if (distance >= 1000) {
                    display = (distance / 1000).toFixed(2) + ' km';
                } else {
                    display = Math.round(distance) + ' m';
                }
                $('#distance-value').text(display);
            }, function() {
                $('#distance-value').text('Không xác định');
            });

            function haversine(lat1, lon1, lat2, lon2) {
                var R = 6371e3; // Bán kính Trái Đất (m)
                var toRad = function(angle) { return angle * Math.PI / 180; };
                var dLat = toRad(lat2 - lat1);
                var dLon = toRad(lon2 - lon1);
                var a = Math.sin(dLat/2)**2 +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon/2)**2;
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // khoảng cách tính bằng mét
            }

            var ctx = document.getElementById('vibrationChart').getContext('2d');

            // Tạo dữ liệu mẫu cho 12 giờ gần nhất
            var hours = [];
            var now = new Date();
            for (var i = 11; i >= 0; i--) {
                var d = new Date(now.getTime() - i * 60 * 60 * 1000);
                hours.push(d.getHours() + ':00');
            }
            var vibrationData = Array.from({length: 12}, function() { return Math.floor(Math.random() * 10); });

            // Khởi tạo biểu đồ đường
            var vibrationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Số lần rung lắc',
                        data: vibrationData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) { return ` ${ctx.parsed.y} lần`; }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            title: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' },
                            title: { display: false },
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Initialize Leaflet map
            var bikeLat = 21.028511, bikeLng = 105.804817;
            var map = L.map('map').setView([bikeLat, bikeLng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([bikeLat, bikeLng]).addTo(map)
                .bindPopup('Vị trí xe máy')
                .openPopup();

            // Restore toggle states from localStorage
            $('#alert-toggle').prop('checked', localStorage.getItem('alert_toggle') === 'on');
            $('#auto-toggle').prop('checked', localStorage.getItem('auto_toggle') === 'on');
            $('#alert-ring-toggle').prop('checked', localStorage.getItem('alert_ring_toggle') === 'on');
            // Save toggle state on change
            $('#alert-toggle').on('change', function() {
                localStorage.setItem('alert_toggle', this.checked ? 'on' : 'off');
            });
            $('#auto-toggle').on('change', function() {
                localStorage.setItem('auto_toggle', this.checked ? 'on' : 'off');
            });
            $('#alert-ring-toggle').on('change', function() {
                localStorage.setItem('alert_ring_toggle', this.checked ? 'on' : 'off');
            });
            lucide.createIcons();

            // Show chatbox
            $('#contact-support-btn').on('click', function() {
                var $chatbox = $('#support-chatbox > div');
                $('#support-chatbox').css('pointer-events', 'auto');
                $chatbox.show();
                lucide.createIcons();
            });
            // Hide chatbox
            $('#close-chatbox-btn').on('click', function() {
                var $chatbox = $('#support-chatbox > div');
                $chatbox.hide();
                $('#support-chatbox').css('pointer-events', 'none');
            });

            // Static bot reply on chat submit
            var $chatForm = $('#support-chatbox form');
            var $chatInput = $chatForm.find('input[type="text"]');
            var $chatBody = $chatForm.parent().find('.p-4.h-64');

            $chatForm.on('submit', function(e) {
                e.preventDefault();
                var userMsg = $chatInput.val().trim();
                if (!userMsg) return;
                // Append user message
                var $userDiv = $('<div>')
                    .addClass('self-end bg-emerald-100 text-emerald-900 px-3 py-2 rounded-lg mb-2')
                    .text(userMsg);
                $chatBody.append($userDiv);

                // Static bot reply
                setTimeout(function() {
                    var $botDiv = $('<div>')
                        .addClass('self-start bg-emerald-50 text-emerald-900 px-3 py-2 rounded-lg mb-2')
                        .text('Cảm ơn bạn đã liên hệ! Chúng tôi sẽ phản hồi sớm nhất.');
                    $chatBody.append($botDiv);
                    $chatBody.scrollTop($chatBody[0].scrollHeight);
                }, 600);

                $chatInput.val('');
                $chatBody.scrollTop($chatBody[0].scrollHeight);
            });
        });
    </script>
</body>
</html>